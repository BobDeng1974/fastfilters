#include "fastfilters.hxx"

#include <iostream>
#include <string.h>
#include <cassert>
#include <cmath>

static const float result[] = {
    7.92574e-42,  -1.36955e-40,              -3.5246e-40,  -6.17509e-40, -8.69073e-40, -9.85263e-40, -7.75034e-40,
    1.45861e-41,  1.65874e-39,               4.36498e-39,  8.11801e-39,  1.2453e-38,   1.61729e-38,  1.70618e-38,
    1.16972e-38,  -4.47392e-39,              -3.65718e-38, -8.89838e-38, -1.63121e-37, -2.54195e-37, -3.47332e-37,
    -4.13913e-37, -4.09835e-37,              -2.78321e-37, 3.92963e-38,  5.8111e-37,   1.32772e-36,  2.1511e-36,
    2.75538e-36,  2.62521e-36,               1.01018e-36,  -3.01134e-36, -1.0333e-35,  -2.1426e-35,  -3.57045e-35,
    -5.06529e-35, -6.08083e-35,              -5.68341e-35, -2.51141e-35, 5.14966e-35,  1.90958e-34,  4.06552e-34,
    6.98097e-34,  1.04015e-33,               1.36903e-33,  1.5726e-33,   1.49007e-33,  9.31735e-34,  -2.68827e-34,
    -2.15822e-33, -4.5161e-33,               -6.66512e-33, -7.27068e-33, -4.20056e-33, 5.43765e-33,  2.49132e-32,
    5.69391e-32,  1.01993e-31,               1.55781e-31,  2.05946e-31,  2.28501e-31,  1.8501e-31,   2.22434e-32,
    -3.23309e-31, -9.13272e-31,              -1.78511e-30, -2.91894e-30, -4.19623e-30, -5.35953e-30, -5.99079e-30,
    -5.53709e-30, -3.42172e-30,              7.15836e-31,  6.61585e-30,  1.28241e-29,  1.60032e-29,  1.0289e-29,
    -1.3007e-29,  -6.48708e-29,              -1.56599e-28, -2.95633e-28, -4.78595e-28, -6.81367e-28, -8.46929e-28,
    -8.73222e-28, -6.05314e-28,              1.61458e-28,  1.65871e-27,  4.09346e-27,  7.56138e-27,  1.19267e-26,
    1.66864e-26,  2.0861e-26,                2.29881e-26,  2.13306e-26,  1.44408e-26,  2.22631e-27,  -1.23927e-26,
    -2.12816e-26, -8.66083e-27,              5.0829e-26,   1.92296e-25,  4.57123e-25,  8.83497e-25,  1.48846e-24,
    2.23975e-24,  3.01775e-24,               3.57153e-24,  3.47898e-24,  2.12823e-24,  -1.2546e-24,  -7.50149e-24,
    -1.72948e-23, -3.08444e-23,              -4.74777e-23, -6.52345e-23, -8.06605e-23, -8.91115e-23, -8.60047e-23,
    -6.95253e-23, -4.52452e-23,              -3.28279e-23, -7.43513e-23, -2.4268e-22,  -6.46706e-22, -1.42829e-21,
    -2.74364e-21, -4.72067e-21,              -7.38412e-21, -1.05443e-20, -1.36541e-20, -1.5654e-20,  -1.48465e-20,
    -8.86742e-21, 5.15687e-21,               3.01692e-20,  6.83871e-20,  1.2017e-19,   1.82732e-19,  2.49167e-19,
    3.08611e-19,  3.48839e-19,               3.62928e-19,  3.61784e-19,  3.93884e-19,  5.72161e-19,  1.10523e-18,
    2.32565e-18,  4.70176e-18,               8.81258e-18,  1.52585e-17,  2.44775e-17,  3.64426e-17,  5.02323e-17,
    6.3506e-17,   7.19719e-17,               6.90158e-17,  4.57371e-17,  -8.30157e-18, -1.03328e-16, -2.46505e-16,
    -4.38276e-16, -6.68947e-16,              -9.17662e-16, -1.15738e-15, -1.37094e-15, -1.58441e-15, -1.92395e-15,
    -2.69944e-15, -4.51233e-15,              -8.37302e-15, -1.57956e-14, -2.88151e-14, -4.98473e-14, -8.12911e-14,
    -1.24772e-13, -1.79955e-13,              -2.42934e-13, -3.04358e-13, -3.47676e-13, -3.48129e-13, -2.7337e-13,
    -8.66704e-14, 2.46636e-13,               7.49753e-13,  1.42427e-12,  2.2446e-12,   3.16684e-12,  4.16714e-12,
    5.32996e-12,  7.00924e-12,               1.0083e-11,   1.63089e-11,  2.87599e-11,  5.22732e-11,  9.37763e-11,
    1.62272e-10,  2.68184e-10,               4.21702e-10,  6.29802e-10,  8.91766e-10,  1.19335e-09,  1.50039e-09,
    1.75325e-09,  1.86457e-09,               1.72312e-09,  1.20625e-09,  2.01622e-10,  -1.36611e-09, -3.51648e-09,
    -6.22829e-09, -9.53225e-09,              -1.37445e-08, -1.99217e-08, -3.06236e-08, -5.10518e-08, -9.05711e-08,
    -1.64508e-07, -2.9593e-07,               -5.16864e-07, -8.68111e-07, -1.39658e-06, -2.14888e-06, -3.1603e-06,
    -4.43868e-06, -5.94447e-06,              -7.57005e-06, -9.12413e-06, -1.0329e-05,  -1.08391e-05, -1.02854e-05,
    -8.33841e-06, -4.76046e-06,              6.21656e-07,  8.14517e-06,  1.89342e-05,  3.61817e-05,  6.74131e-05,
    0.000128057,  0.000246553,               0.000470976,  0.000876682,  0.00157379,   0.00271242,   0.00448255,
    0.00710488,   0.0108086,                 0.0157936,    0.0221775,    0.0299334,    0.0388308,    0.0484012,
    0.0579514,    0.0666443,                 0.0736383,    0.0782184,    0.0797446,    0.0782184,    0.0736383,
    0.0666444,    0.0579515,                 0.0484013,    0.0388309,    0.0299335,    0.0221775,    0.0157936,
    0.0108086,    0.00710487,                0.00448255,   0.00271242,   0.00157381,   0.000876702,  0.000470998,
    0.000246574,  0.000128075,               6.7428e-05,   3.61927e-05,  1.89418e-05,  8.15002e-06,  6.24514e-07,
    -4.75893e-06, -8.3377e-06,               -1.02851e-05, -1.0839e-05,  -1.0329e-05,  -9.12415e-06, -7.57005e-06,
    -5.94444e-06, -4.43864e-06,              -3.16026e-06, -2.14885e-06, -1.39655e-06, -8.68095e-07, -5.16856e-07,
    -2.9593e-07,  -1.64513e-07,              -9.0579e-08,  -5.10606e-08, -3.0632e-08,  -1.99289e-08, -1.37502e-08,
    -9.53651e-09, -6.23126e-09,              -3.51843e-09, -1.36732e-09, 2.00915e-10,  1.20586e-09,  1.72291e-09,
    1.86446e-09,  1.75318e-09,               1.50034e-09,  1.19331e-09,  8.91729e-10,  6.29771e-10,  4.21676e-10,
    2.68165e-10,  1.62259e-10,               9.37682e-11,  5.2269e-11,   2.87585e-11,  1.63092e-11,  1.00842e-11,
    7.01069e-12,  5.33138e-12,               4.16834e-12,  3.16776e-12,  2.24525e-12,  1.4247e-12,   7.50027e-13,
    2.46798e-13,  -8.65778e-14,              -2.73317e-13, -3.48097e-13, -3.47655e-13, -3.04342e-13, -2.42921e-13,
    -1.79945e-13, -1.24764e-13,              -8.1285e-14,  -4.98433e-14, -2.88128e-14, -1.57945e-14, -8.37269e-15,
    -4.51246e-15, -2.69977e-15,              -1.92433e-15, -1.58476e-15, -1.37121e-15, -1.15757e-15, -9.17786e-16,
    -6.6902e-16,  -4.38316e-16,              -2.46525e-16, -1.03337e-16, -8.30644e-18, 4.57336e-17,  6.90124e-17,
    7.19682e-17,  6.35022e-17,               5.02289e-17,  3.64397e-17,  2.44752e-17,  1.52568e-17,  8.81157e-18,
    4.70122e-18,  2.32543e-18,               1.10523e-18,  5.72271e-19,  3.94035e-19,  3.61934e-19,  3.63054e-19,
    3.48935e-19,  3.08677e-19,               2.49209e-19,  1.82756e-19,  1.20182e-19,  6.83928e-20,  3.01715e-20,
    5.15784e-21,  -8.86676e-21,              -1.48457e-20, -1.5653e-20,  -1.36531e-20, -1.05433e-20, -7.38325e-21,
    -4.72e-21,    -2.74317e-21,              -1.42799e-21, -6.46547e-22, -2.42613e-22, -7.43404e-23, -3.28455e-23,
    -4.5273e-23,  -6.95526e-23,              -8.60267e-23, -8.91267e-23, -8.06697e-23, -6.52393e-23, -4.74795e-23,
    -3.08446e-23, -1.72943e-23,              -7.50096e-24, -1.25424e-24, 2.12835e-24,  3.47888e-24,  3.57131e-24,
    3.01747e-24,  2.23948e-24,               1.48822e-24,  8.83318e-25,  4.57002e-25,  1.92222e-25,  5.07919e-26,
    -8.67404e-27, -2.12811e-26,              -1.23858e-26, 2.23483e-27,  1.44484e-26,  2.13362e-26,  2.29918e-26,
    2.0863e-26,   1.66872e-26,               1.19268e-26,  7.56119e-27,  4.09319e-27,  1.65849e-27,  1.61331e-28,
    -6.05347e-28, -8.73185e-28,              -8.46852e-28, -6.81276e-28, -4.78509e-28, -2.95562e-28, -1.56547e-28,
    -6.48365e-29, -1.29871e-29,              1.02984e-29,  1.60061e-29,  1.28233e-29,  6.61356e-30,  7.1331e-31,
    -3.42384e-30, -5.53858e-30,              -5.99168e-30, -5.35994e-30, -4.19634e-30, -2.91888e-30, -1.785e-30,
    -9.13159e-31, -3.23227e-31,              2.2287e-32,   1.85021e-31,  2.28489e-31,  2.05923e-31,  1.55755e-31,
    1.01969e-31,  5.692e-32,                 2.48995e-32,  5.42892e-33,  -4.20545e-33, -7.27292e-33, -6.66573e-33,
    -4.51587e-33, -2.15768e-33,              -2.68267e-34, 9.32171e-34,  1.49034e-33,  1.57273e-33,  1.36906e-33,
    1.04013e-33,  6.98051e-34,               4.06504e-34,  1.90919e-34,  5.14707e-35,  -2.51274e-35, -5.68378e-35,
    -6.08058e-35, -5.06474e-35,              -3.56983e-35, -2.14204e-35, -1.03286e-35, -3.00831e-36, 1.01201e-36,
    2.62614e-36,  2.75572e-36,               2.15111e-36,  1.32758e-36,  5.80938e-37,  3.91489e-38,  -2.78423e-37,
    -4.0989e-37,  -4.13933e-37,              -3.4733e-37,  -2.54182e-37, -1.63104e-37, -8.89692e-38, -3.65612e-38,
    -4.46747e-39, 1.17002e-38,               1.70624e-38,  1.6172e-38,   1.24515e-38,  8.1165e-39,   4.36371e-39,
    1.65782e-39,  1.40088e-41 - 7.75338e-40, -9.85375e-40, -8.6907e-40,  -6.17451e-40, -3.5239e-40,  -1.36896e-40,
    -1.36896e-40, 8.62233e-41,               7.92574e-42};

int main()
{
    static float input[2 * 512];
    static float output[2 * 512];

    memset(input, 0, sizeof(input));

    input[256] = 1.0;
    input[512 + 257] = 1.0;

    fastfilters::iir::Coefficients coefs(5.0, 0);
    fastfilters::iir::convolve_iir_inner_single(input, 512, 2, output, coefs, 32);

    for (unsigned i = 0; i < 512; ++i)
        assert(abs(output[i] - result[i]) < 1e-12);

    for (unsigned i = 0; i < 511; ++i)
        assert(abs(output[512 + i] - result[i + 1]) < 1e-12);

    static float input2[512 * 50];
    static float output2[512 * 50];

    memset(input2, 0, sizeof(input2));
    memset(output2, 0, sizeof(output2));
    for (unsigned int i = 0; i < 50; ++i)
        input2[256 * 50 + i] = 1.0;

    fastfilters::iir::convolve_iir_outer_single(input2, 512, 50, output2, coefs, 32, 50);

    for (unsigned i = 0; i < 512; ++i)
        assert(abs(output2[i * 50] - result[i]) < 1e-12);

    return 0;
}